    const paisesFalabella = [
        { nombre: 'Chile', codigo: 'CL' },
        { nombre: 'Colombia', codigo: 'CO' },
        { nombre: 'Perú', codigo: 'PE' }
    ];

    const paisesSodimac = [
        { nombre: 'Chile', codigo: 'CL' },
        { nombre: 'Argentina', codigo: 'AR' },
        { nombre: 'Colombia', codigo: 'CO' },
        { nombre: 'Perú', codigo: 'PE' },
        { nombre: 'Brasil', codigo: 'BR' },
        { nombre: 'México', codigo: 'MX' },
        { nombre: 'Uruguay', codigo: 'UY' }
    ];

    function actualizarPaises() {
        const contenedor = $('#paisesContainer');
        contenedor.empty();
        contenedor.append('<div>Descargar imágenes desde:</div><br>');
        const paises = useFalabella ? paisesFalabella : paisesSodimac;
        paises.forEach(p => {
            const div = $('<div>').addClass('pais').attr('data-pais', p.codigo).text(p.nombre);
            if (p.codigo === pais) div.addClass('seleccionado');
            contenedor.append(div);
        });
        $('.pais').click(function() {
            pais = $(this).data('pais');
            $('.pais').removeClass('seleccionado');
            $(this).addClass('seleccionado');
        });
    }

    $('#falabellaIcon').click(function() {
        useFalabella = true;
        $('#falabellaIcon').removeClass('inactive').attr('src', 'https://raw.githubusercontent.com/PabloMolinaTorres/Visualiza2/main/falabella.png');
        $('#sodimacIcon').addClass('inactive').attr('src', 'https://raw.githubusercontent.com/PabloMolinaTorres/Visualiza2/main/sodimac-bn.png');
        actualizarPaises();
    });

    $('#sodimacIcon').click(function() {
        useFalabella = false;
        $('#sodimacIcon').removeClass('inactive').attr('src', 'https://raw.githubusercontent.com/PabloMolinaTorres/Visualiza2/main/sodimac.png');
        $('#falabellaIcon').addClass('inactive').attr('src', 'https://raw.githubusercontent.com/PabloMolinaTorres/Visualiza2/main/falabella-bn.png');
        actualizarPaises();
    });

    $('#viewToggle').change(function() {
        viewMode = $(this).is(':checked') ? 'sku' : 'vista';
        if (viewMode === 'vista') {
            $('.imgContainer').show();
            $('#thumbnailContainer').hide();
        } else {
            $('.imgContainer').hide();
            $('#thumbnailContainer').show();
        }
    });

    $('#buscar').click(function() {
        $('#ordenarVistas').attr('disabled', true).removeClass('enabled').addClass('disabled');  // Deshabilitar botón de ordenar
        $('#errorList').empty();  // Limpiar la lista de errores
        $('#errorList').append('<button id="copyErrors" disabled>Copiar</button>');  // Añadir botón copiar deshabilitado
        if (viewMode === "vista") {
            buscarPorVista();
        } else {
            buscarPorSKU();
        }
    });

    $('#ordenarVistas').click(function() {
        if (!$(this).attr('disabled')) {
            $('#buscar').click();
        }
    });

    $('#copyErrors').click(function() {
        if ($(this).attr('disabled')) return;
        var errors = [];
        $('#errorList div').each(function() {
            errors.push($(this).text());
        });
        var tempInput = $('<textarea>');
        $('body').append(tempInput);
        tempInput.val(errors.join('\n')).select();
        document.execCommand('copy');
        tempInput.remove();
        $(this).text('Copiado').addClass('copied');
        setTimeout(() => {
            $('#copyErrors').text('Copiar').removeClass('copied');
        }, 2000);
    });

    async function buscarPorVista() {
        $('.imgContainer').empty();
        $('#error').text('');
        var skus = $('#skus').val().split('\n');
        var promises = [];

        for (let sku of skus) {
            sku = sku.trim();
            if (sku !== "") {
                promises.push(loadImage(sku));
            }
        }

        const images = await Promise.all(promises);

        const seenErrors = new Set();

        images.forEach(image => {
            if (image && !image.error) {
                $('.imgContainer').append(image.element);
            } else if (image && image.error && !seenErrors.has(image.sku)) {
                seenErrors.add(image.sku);
                $('#errorList').append('<div>' + image.sku + '</div>');
            }
        });

        updateCopyButtonState();

        $('#ordenarVistas').removeAttr('disabled').removeClass('disabled').addClass('enabled');  // Habilitar botón de ordenar
    }

    function buscarPorSKU() {
        $('#thumbnailContainer').empty();
        var skus = $('#skus').val().split('\n');
        var promises = [];

        skus.forEach(function(sku, index) {
            sku = sku.trim();
            if (sku !== "") {
                var row = $('<div class="thumbnail-row"></div>');
                if (index > 0) {
                    $('#thumbnailContainer').append('<div class="divider"></div>');
                }
                $('#thumbnailContainer').append(row);
                var variants = useFalabella 
                    ? ['_01', '_02', '_03', '_1', '_10', '_11', '_2', '_3', '_4', '_5', '_6', '_7', '_8', '_9', '_90', '_91', '_92', '_93', '_94', '_95', '_96', '_97', '_98', '_99']
                    : ['_1', '_01', '_02', '_03', '_04', '_05', '_06', '_07', '_08', '_09', '_10', '_11', '_12', '_13', '_14', '_15', '_16', '_17', '_18', '_19', '_20', '_21', '_22', '_23', '_24', '_25', '_26', '_27', '_28', '_29', '_30', '_31', '_32', '_33', '_34', '_35', '_EFI', '_SEC'];
                promises.push(displayThumbnailsInOrder(sku, variants, row));
            }
        });

        Promise.all(promises).then(() => {
            updateCopyButtonState();
            $('#ordenarVistas').removeAttr('disabled').removeClass('disabled').addClass('enabled');  // Habilitar botón de ordenar
        });
    }

    function updateCopyButtonState() {
        const hasErrors = $('#errorList div').length > 0;
        $('#copyErrors').attr('disabled', !hasErrors);
        if (hasErrors) {
            $('#copyErrors').removeAttr('disabled').removeClass('copied').text('Copiar');
        }
    }

    async function displayThumbnailsInOrder(sku, variants, row) {
        const promises = variants.map(variant => createThumbnail(sku + variant, row));
        await Promise.all(promises);
    }

    function createThumbnail(sku, row) {
        return new Promise((resolve) => {
            var baseUrl = useFalabella ? 'https://imagedelivery.net/4fYuQyy-r8_rpBpcY7lH_A/falabella' : 'https://imagedelivery.net/4fYuQyy-r8_rpBpcY7lH_A/sodimac';
            let thumbnailUrl = `${baseUrl}${pais}/${sku}/w=200,h=200,fit=pad`;
            let originalUrl = `${baseUrl}${pais}/${sku}/w=1500,h=1500,fit=pad`;
            var img = new Image();
            img.src = thumbnailUrl;
            img.alt = sku;
            img.onload = function() {
                var thumbnail = $('<div class="thumbnail"></div>');
                var link = $('<a href="' + originalUrl + '" data-lightbox="image-gallery" data-title="' + sku + '"></a>');
                link.append(img);
                thumbnail.append(link);
                thumbnail.append('<div class="sku">' + sku + '</div>');
                thumbnail.mouseenter(function() {
                    var zoom = $('<div class="zoom"></div>');
                    zoom.css({
                        'background-image': 'url(' + originalUrl + ')',
                        'background-size': '500px 500px'
                    });
                    $('body').append(zoom);
                    zoom.fadeIn(200);
                    thumbnail.on('mousemove', function(e) {
                        var offset = thumbnail.offset();
                        var posX = e.pageX - offset.left;
                        var posY = e.pageY - offset.top;
                        zoom.css({
                            'left': e.pageX + 10,
                            'top': e.pageY + 10,
                            'background-position': '-' + (posX * 1 - zoom.width() / 2) + 'px -' + (posY * 1 - zoom.height() / 2) + 'px'
                        });
                    });
                });
                thumbnail.mouseleave(function() {
                    var zoom = $('body').find('.zoom');
                    zoom.fadeOut(200, function() {
                        zoom.remove();
                    });
                });
                row.append(thumbnail);
                resolve();
            };
            img.onerror = function() {
                if (viewMode === "sku") {
                    $('#errorList').append('<div>' + sku + '</div>');
                    updateCopyButtonState();
                }
                resolve(); // Resolviendo la promesa sin añadir la miniatura "No disponible"
            };
        });
    }

    function loadImage(sku) {
        return new Promise(function(resolve, reject) {
            var baseUrl = useFalabella ? 'https://imagedelivery.net/4fYuQyy-r8_rpBpcY7lH_A/falabella' : 'https://imagedelivery.net/4fYuQyy-r8_rpBpcY7lH_A/sodimac';
            var primaryUrl = `${baseUrl}${pais}/${sku}/public`;
            var downloadUrl = `${baseUrl}${pais}/${sku}/w=1500,h=1500`;
            var alternateUrl = `${baseUrl}${pais}/inpage_media/${sku}/public`;

            console.log("Loading image for SKU: " + sku + " from URL: " + primaryUrl);
            var img = new Image();
            img.src = primaryUrl;
            img.alt = sku;
            img.setAttribute('data-download-src', downloadUrl);

            img.onload = function() {
                var wrapper = $('<div class="imgWrapper"><a href="' + primaryUrl + '" target="_blank"></a></div>');
                wrapper.find('a').append(img);
                resolve({ element: wrapper, sku: sku });
            };

            img.onerror = function() {
                if (sku.includes('-')) {
                    console.log("Trying alternate URL for SKU: " + sku);
                    img.src = alternateUrl;
                    img.setAttribute('data-download-src', alternateUrl);
                    img.onload = function() {
                        var wrapper = $('<div class="imgWrapper"><a href="' + alternateUrl + '" target="_blank"></a></div>');
                        wrapper.find('a').append(img);
                        resolve({ element: wrapper, sku: sku });
                    };
                    img.onerror = function() {
                        console.log("Error loading image for SKU: " + sku);
                        if (viewMode === "sku") {
                            $('#errorList').append('<div>' + sku + '</div>');
                            updateCopyButtonState();
                        }
                        resolve({ error: true, sku: sku });
                    };
                } else {
                    console.log("Error loading image for SKU: " + sku);
                    if (viewMode === "sku") {
                        $('#errorList').append('<div>' + sku + '</div>');
                        updateCopyButtonState();
                    }
                    resolve({ error: true, sku: sku });
                }
            };
        });
    }

    $('#descargartodo').click(function() {
        var zip = new JSZip();
        var count = 0;
        var zipFilename = getFormattedDate() + ".zip";
        var urls = [];
        var skuNames = [];
        if (viewMode === "vista") {
            $(".imgWrapper img").each(function() {
                urls.push($(this).attr('data-download-src'));
                skuNames.push($(this).attr('alt'));
            });
        } else {
            $(".thumbnail img").each(function() {
                var originalUrl = $(this).parent().attr('href');
                urls.push(originalUrl);
                skuNames.push($(this).attr('alt'));
            });
        }

        urls.forEach(function(url, index) {
            var filename = skuNames[index] + ".jpg";
            JSZipUtils.getBinaryContent(url, function (err, data) {
                if (err) {
                    throw err;
                }
                zip.file(filename, data, { binary: true });
                count++;
                if (count === urls.length) {
                    zip.generateAsync({ type: 'blob' }).then(function (content) {
                        saveAs(content, zipFilename);
                    });
                }
            });
        });
    });

    function getFormattedDate() {
        var date = new Date();
        var day = String(date.getDate()).padStart(2, '0');
        var month = String(date.getMonth() + 1).padStart(2, '0');
        var hours = String(date.getHours()).padStart(2, '0');
        var minutes = String(date.getMinutes()).padStart(2, '0');
        return day + '/' + month + '_' + hours + minutes;
    }

    actualizarPaises();
</script>
